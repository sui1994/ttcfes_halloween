# 🎃 Halloween 画像置換システム - 統合ガイド

## 🚀 システム概要

ArrayBuffer 方式で PNG/GIF 画像をリアルタイム置換するシステムです。
WebSocket を使用して操作側から表示側へ瞬時に画像を送信・置換できます。

## 🎯 置換可能な画像

### 1. 横からアニメーションするキャラクター（20 体）

**フォルダ：** `images/changeable/flying-characters/`

- `character1.png` ～ `character20.png`
- 画面を横切ってアニメーションします
- 推奨サイズ：幅 40px 程度
- 対応要素：`.character1` ～ `.character20`

### 2. 歩行キャラクター（10 体）

**フォルダ：** `images/changeable/walking-characters/`

- `walking-left-1.png` ～ `walking-left-5.png` - 左から歩いてくる
- `walking-right-1.png` ～ `walking-right-5.png` - 右から歩いてくる
- 推奨サイズ：幅 60px 程度
- 対応要素：`.walking-left`, `.walking-left-2` ～ `.walking-right-5`

## 🔧 使用方法

### 方法 1: リアルタイム置換（推奨）

1. **操作側 (control.html)**

   - 「画像置換システム」セクションにアクセス
   - 画像をドラッグ&ドロップまたはファイル選択
   - 自動的に WebSocket 経由で送信

2. **表示側 (halloween.html)**
   - 自動的に画像を受信・置換
   - 置換時に光るエフェクトが発生

### 方法 2: 直接ファイル置換

1. **新しい画像を用意**

   - PNG、GIF、JPG 形式
   - 背景透明推奨
   - 適切なサイズに調整

2. **画像を置き換え**
   - 対応するフォルダに画像をコピー
   - **元のファイル名と同じ名前にする**
   - 例：`character1.png` → 新しい画像も `character1.png`

## 📋 対応形式・仕様

### ファイル形式

- **PNG**: 透明度対応、推奨形式
- **GIF**: アニメーション対応
- **JPEG**: 写真系画像
- **WebP**: 高圧縮形式

### 制限事項

- **最大ファイルサイズ**: 10MB
- **推奨サイズ**:
  - 飛行キャラクター: 幅 40px 程度
  - 歩行キャラクター: 幅 60px 程度

## 📁 システム構成

```
Halloween_pre/
├── js/
│   ├── image-replacer.js          # 表示側: 画像置換処理
│   ├── control-image-uploader.js  # 操作側: アップロード機能
│   ├── websocket-client.js        # WebSocket通信
│   └── control-panel.js           # 操作パネル統合
├── images/
│   └── changeable/
│       ├── flying-characters/     # 飛行キャラクター画像
│       └── walking-characters/    # 歩行キャラクター画像
└── preset_img/                    # 元画像のバックアップ
```

## ⚡ 技術仕様

### ArrayBuffer 通信フロー

1. 操作側: ファイル → ArrayBuffer 変換
2. WebSocket: メタデータ送信 → バイナリデータ送信
3. 表示側: ArrayBuffer → Blob → Object URL → 画像置換

### 自動マッチング

- `character1.png` → `.character1` 要素に自動適用
- `walking-left-1.png` → `.walking-left` 要素に自動適用

### 視覚エフェクト

- 置換時の光るエフェクト
- ハロウィンテーマのパーティクル演出
- オレンジ・ゴールドのエフェクト

## ⚠️ 注意事項

- **`images/fixed/`フォルダは触らない！**
- 元のファイル名を変更しない
- 画像サイズが大きすぎると動作が重くなります
- バックアップを取ってから作業することをお勧めします

## 🔄 元に戻したい場合

元の画像は `preset_img/` フォルダに残っています。
必要に応じてコピーし直してください。

## 🛠️ サーバー設定

Socket.io サーバーに以下を追加:

```javascript
// 画像メタデータ中継
socket.on("image-metadata", (metadata) => {
  socket.broadcast.to("displays").emit("image-metadata", metadata);
});

// 画像バイナリデータ中継
socket.on("image-data", (arrayBuffer) => {
  socket.broadcast.to("displays").emit("image-data", arrayBuffer);
});
```

## 🐛 トラブルシューティング

### 画像が置換されない

1. ファイル名が正確か確認 (`character1.png` など)
2. 対象要素が存在するか確認
3. WebSocket 接続状況を確認

### メモリ使用量が多い

- ブラウザのリロードでキャッシュクリア
- 大きすぎる画像ファイルを避ける

### GIF アニメーションが動かない

- ファイル形式が GIF か確認
- ブラウザの GIF サポート状況を確認

## 🎨 カスタマイズ

新しい画像要素を追加する場合は、`image-replacer.js` の `findTargetElements()` メソッドを編集してください。

---

**作成者**: Kiro AI Assistant  
**バージョン**: 2.0.0 (統合版)  
**対応ブラウザ**: Chrome, Firefox, Safari, Edge (WebSocket + ArrayBuffer 対応)
