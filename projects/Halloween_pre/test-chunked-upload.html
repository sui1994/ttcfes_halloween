<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>ğŸ§ª ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a1a;
      color: white;
    }

    .test-container {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }

    .upload-area {
      border: 2px dashed #ff6b35;
      border-radius: 10px;
      padding: 40px 20px;
      text-align: center;
      background: rgba(255, 107, 53, 0.1);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .upload-area:hover {
      border-color: #ffd700;
      background: rgba(255, 215, 0, 0.1);
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4caf50, #8bc34a);
      width: 0%;
      transition: width 0.3s ease;
    }

    .status {
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }

    .status.success {
      background: rgba(76, 175, 80, 0.2);
      color: #4caf50;
    }

    .status.error {
      background: rgba(244, 67, 54, 0.2);
      color: #f44336;
    }

    .status.info {
      background: rgba(33, 150, 243, 0.2);
      color: #2196f3;
    }

    .btn {
      background: #ff6b35;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }

    .btn:hover {
      background: #e55a2b;
    }

    .log {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 5px;
      padding: 15px;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>

<body>
  <h1>ğŸ§ª WebSocketãƒãƒ£ãƒ³ã‚¯åˆ†å‰²ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ</h1>

  <div class="test-container">
    <h2>ğŸ“¡ æ¥ç¶šçŠ¶æ³</h2>
    <div id="connection-status" class="status info">ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šä¸­...</div>
  </div>

  <div class="test-container">
    <h2>ğŸ“¤ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
    <div class="upload-area" id="upload-area">
      <div>ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</div>
      <div style="margin-top: 10px; font-size: 12px; color: #ccc;">
        å¯¾å¿œå½¢å¼: PNG, GIF, JPEG, WebP (æœ€å¤§10MB)
      </div>
      <input type="file" id="file-input" accept="image/*" style="display: none;">
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="progress-fill"></div>
    </div>
    <div id="progress-text">0%</div>

    <div id="upload-status" class="status" style="display: none;"></div>
  </div>

  <div class="test-container">
    <h2>ğŸ›ï¸ ãƒ†ã‚¹ãƒˆæ“ä½œ</h2>
    <button class="btn" onclick="testConnection()">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
    <button class="btn" onclick="generateTestFile()">ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ</button>
    <button class="btn" onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
  </div>

  <div class="test-container">
    <h2>ğŸ“‹ ãƒ­ã‚°</h2>
    <div class="log" id="log"></div>
  </div>

  <!-- Socket.io ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- WebSocket File Uploader -->
  <script src="js/websocket-file-uploader.js"></script>

  <script>
    let socket;
    let fileUploader;

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
      initializeSocket();
      setupFileUpload();
      log('ğŸš€ ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†');
    });

    // Socket.ioåˆæœŸåŒ–
    function initializeSocket() {
      socket = io();

      socket.on('connect', () => {
        log('âœ… WebSocketæ¥ç¶šæˆåŠŸ');
        updateConnectionStatus('æ¥ç¶šæ¸ˆã¿', 'success');

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼åˆæœŸåŒ–
        fileUploader = new WebSocketFileUploader(socket);

        // é€²æ—ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
        fileUploader.setProgressCallback((progress) => {
          updateProgress(progress);
          log(`ğŸ“Š ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é€²æ—: ${progress}%`);
        });

        // å®Œäº†ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
        fileUploader.setCompleteCallback((response) => {
          log(`âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†: ${response.filename}`);
          showStatus('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†!', 'success');
          updateProgress(100);
        });

        // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
        fileUploader.setErrorCallback((error) => {
          log(`âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${error}`);
          showStatus(`ã‚¨ãƒ©ãƒ¼: ${error}`, 'error');
        });
      });

      socket.on('disconnect', () => {
        log('âŒ WebSocketåˆ‡æ–­');
        updateConnectionStatus('åˆ‡æ–­', 'error');
      });

      socket.on('connect_error', (error) => {
        log(`âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`);
        updateConnectionStatus('æ¥ç¶šã‚¨ãƒ©ãƒ¼', 'error');
      });
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è¨­å®š
    function setupFileUpload() {
      const uploadArea = document.getElementById('upload-area');
      const fileInput = document.getElementById('file-input');

      // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
      uploadArea.addEventListener('click', () => {
        fileInput.click();
      });

      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          uploadFile(file);
        }
      });

      // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#ffd700';
      });

      uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#ff6b35';
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#ff6b35';

        const file = e.dataTransfer.files[0];
        if (file) {
          uploadFile(file);
        }
      });
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
    async function uploadFile(file) {
      if (!fileUploader) {
        showStatus('WebSocketãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
        return;
      }

      log(`ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`);
      showStatus(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­: ${file.name}`, 'info');
      updateProgress(0);

      try {
        await fileUploader.uploadFile(file);
      } catch (error) {
        log(`âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${error.message}`);
        showStatus(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${error.message}`, 'error');
      }
    }

    // é€²æ—æ›´æ–°
    function updateProgress(progress) {
      const progressFill = document.getElementById('progress-fill');
      const progressText = document.getElementById('progress-text');

      progressFill.style.width = `${progress}%`;
      progressText.textContent = `${progress.toFixed(1)}%`;
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
    function showStatus(message, type) {
      const statusDiv = document.getElementById('upload-status');
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
      statusDiv.style.display = 'block';
    }

    // æ¥ç¶šçŠ¶æ³æ›´æ–°
    function updateConnectionStatus(status, type) {
      const statusDiv = document.getElementById('connection-status');
      statusDiv.textContent = `WebSocket: ${status}`;
      statusDiv.className = `status ${type}`;
    }

    // ãƒ­ã‚°å‡ºåŠ›
    function log(message) {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // ãƒ†ã‚¹ãƒˆé–¢æ•°
    function testConnection() {
      if (socket && socket.connected) {
        socket.emit('ping', { test: true, timestamp: Date.now() });
        log('ğŸ“ Pingé€ä¿¡');
      } else {
        log('âŒ WebSocketæœªæ¥ç¶š');
      }
    }

    function generateTestFile() {
      // 1MBã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
      const canvas = document.createElement('canvas');
      canvas.width = 1000;
      canvas.height = 1000;
      const ctx = canvas.getContext('2d');

      // ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æç”»
      for (let i = 0; i < 100; i++) {
        ctx.fillStyle = `hsl(${Math.random() * 360}, 50%, 50%)`;
        ctx.fillRect(Math.random() * 1000, Math.random() * 1000, 50, 50);
      }

      canvas.toBlob((blob) => {
        const file = new File([blob], 'test-image.png', { type: 'image/png' });
        log(`ğŸ¨ ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`);
        uploadFile(file);
      }, 'image/png');
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
      log('ğŸ§¹ ãƒ­ã‚°ã‚¯ãƒªã‚¢');
    }
  </script>
</body>

</html>